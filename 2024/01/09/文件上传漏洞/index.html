<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>文件上传漏洞 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="文件上传漏洞原理由于程序员在对用户文件上传功能实现代码上没有严格限制用户上传的文件后缀以及文件类型或者处理缺陷,而导致用户可以越过其本身权限向服务器上上传可执行的动态脚本文件: 简单的来说: 服务器端没有对客户端上传的文件进行严格验证或过滤,用户可以上传一个可执行的脚本文件,并通过此脚本获得了执行服务器端命令的能力. 一句话代码1&lt;?php @system($_GET[a]); ?&gt;">
<meta property="og:type" content="article">
<meta property="og:title" content="文件上传漏洞">
<meta property="og:url" content="http://example.com/2024/01/09/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="文件上传漏洞原理由于程序员在对用户文件上传功能实现代码上没有严格限制用户上传的文件后缀以及文件类型或者处理缺陷,而导致用户可以越过其本身权限向服务器上上传可执行的动态脚本文件: 简单的来说: 服务器端没有对客户端上传的文件进行严格验证或过滤,用户可以上传一个可执行的脚本文件,并通过此脚本获得了执行服务器端命令的能力. 一句话代码1&lt;?php @system($_GET[a]); ?&gt;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240109192458343.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240109192750861.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240109192913974.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240109193130147.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240109194006095.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240109194056094.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240109194922574.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240109195416523.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240109195452904.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240109200114276.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240109200325436.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240117192248457.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240117192510344.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240117192727762.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240117194646736.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240117200444545.png">
<meta property="article:published_time" content="2024-01-09T02:43:45.000Z">
<meta property="article:modified_time" content="2024-01-18T02:24:10.520Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240109192458343.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/plugin/bganimation/bg.css">

  

  <link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" rel="stylesheet" type="text/css">
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <div class="outer">
        <div class="widget-wrap mobile-header">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="https://avatars0.githubusercontent.com/u/20333903?v=3&amp;s=460">
    <h2 class="author">John Doe</h2>
    <h3 class="description"></h3>
    <div class="count-box">
      <a href="/archives"><div><strong>65</strong><br>文章</div></a>
      <a href="/categories"><div><strong>0</strong><br>分类</div></a>
      <a href="/tags"><div><strong>1</strong><br>标签</div></a>
    </div>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>主页</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>归档</li>
          </a>
        
          <a href="/categories" title="Categories">
            <li>分类</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>标签</li>
          </a>
        
    </ul>
  </div>
</div>

        <section id="main"><article id="post-文件上传漏洞" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2024/01/09/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time class="post-time" datetime="2024-01-09T02:43:45.000Z" itemprop="datePublished">
    <span class="post-month">1月</span><br/>
    <span class="post-day">09</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      文件上传漏洞
    </h1>
  

        <div>
          
          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="文件上传漏洞原理"><a href="#文件上传漏洞原理" class="headerlink" title="文件上传漏洞原理"></a>文件上传漏洞原理</h3><p>由于程序员在对用户文件上传功能实现代码上没有严格限制用户上传的文件后缀以及文件类型或者处理缺陷,而导致用户可以越过其本身权限向服务器上上传可执行的动态脚本文件:</p>
<p>简单的来说:</p>
<p>服务器端没有对客户端上传的文件进行严格验证或过滤,用户可以上传一个可执行的脚本文件,并通过此脚本获得了执行服务器端命令的能力.</p>
<h4 id="一句话代码"><a href="#一句话代码" class="headerlink" title="一句话代码"></a>一句话代码</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php @system($_GET[a]); ?&gt;</span><br></pre></td></tr></table></figure>

<h3 id="文件上传绕过"><a href="#文件上传绕过" class="headerlink" title="文件上传绕过"></a>文件上传绕过</h3><h4 id="1-前端验证绕过"><a href="#1-前端验证绕过" class="headerlink" title="1.前端验证绕过"></a>1.前端验证绕过</h4><p>前端对上传文件的验证是利用js的，也就是说当数据包发出去之后前端验证就没用了，想要绕过前端验证有很多方法：</p>
<ul>
<li>浏览器禁用掉JS</li>
<li>抓包修改上传文件数据包（点击上传文件的按钮后抓包）</li>
<li>抓包修改页面的返回包，把js代码删除掉（刷新界面抓包）</li>
</ul>
<blockquote>
<p>导入一句话代码</p>
<p>按f12打开控制台</p>
<p>打开设置</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240109192458343.png" alt="image-20240109192458343"></p>
<blockquote>
<p>禁用js</p>
<p>点击上传</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240109192750861.png" alt="image-20240109192750861"></p>
<blockquote>
<p>看到没报错基本可以了</p>
<p>右键复制图片链接，并在另一个页面中打开</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240109192913974.png" alt="image-20240109192913974"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在网站后添加：?a=ipconfig(Windows系统命令都行)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240109193130147.png" alt="image-20240109193130147"></p>
<p>说明已经文件上传成功</p>
<h4 id="2-Content-Type绕过"><a href="#2-Content-Type绕过" class="headerlink" title="2.Content-Type绕过"></a>2.Content-Type绕过</h4><p>允许某种类型：属于白名单机制</p>
<p>用抓包工具抓取文件上传的包，将content-type内的改为image&#x2F;png或image&#x2F;png或image&#x2F;gif。</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240109194006095.png" alt="image-20240109194006095"></p>
<p>放包后可以看到文件成功上传</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240109194056094.png" alt="image-20240109194056094"></p>
<h4 id="3-黑名单绕过"><a href="#3-黑名单绕过" class="headerlink" title="3.黑名单绕过"></a>3.黑名单绕过</h4><p>后端会定义一个黑名单，对黑名单当中的文件类型进行阻止。</p>
<p>怎么判断是黑名单验证呢？</p>
<p><strong>可以尝试随便输入一个后缀名，如果不拦截，说明是黑名单验证</strong></p>
<ul>
<li>.php .php3 .php4 .php5 .phtml    都会被当作php代码执行</li>
<li>.jsp .jspx .jspf    都会被当作jsp代码执行</li>
<li>.asp .asa .cer .aspx    都会被当作asp执行</li>
<li>.exe .exee    都会被当作exe执行</li>
</ul>
<blockquote>
<p>将文件的后缀名改为.phtml</p>
<p>然后在上传</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240109194922574.png" alt="image-20240109194922574"></p>
<h4 id="4-htaccess文件绕过"><a href="#4-htaccess文件绕过" class="headerlink" title="4. .htaccess文件绕过"></a>4. .htaccess文件绕过</h4><p>.htaccess文件：超文本入口，也被称为分布式配置文件，提供了针对目录改变配置的方法，在一个特定的目录中放置一个包含一个或多个指令的htaccess文件，以作用于此目录及其所有子目录。</p>
<p><strong>也就是说我们可以利用这个文件给不同的目录配置不同的规则。</strong></p>
<p>.htaccess文件规定的规则优先级高于默认规则。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;zhang.jpg&quot;&gt;#引号里写得是要上传的文件</span><br><span class="line">  SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p> 先上传.htaccess文件</p>
<p>再上传zhang.jpg</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240109195416523.png" alt="image-20240109195416523"></p>
<p><img src="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240109195452904.png" alt="image-20240109195452904"></p>
<h4 id="6-后缀大小写绕过"><a href="#6-后缀大小写绕过" class="headerlink" title="6.后缀大小写绕过"></a>6.后缀大小写绕过</h4><p>如果黑名单没过滤全，并且没有将上传的文件后缀全部转换为小写（大写），那么就可以<strong>尝试修改后缀名的大小写</strong>来绕过黑名单的过滤。</p>
<blockquote>
<p>将文件后缀名改为.PhP</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240109200114276.png" alt="image-20240109200114276"></p>
<h4 id="7-后缀（空格）绕过"><a href="#7-后缀（空格）绕过" class="headerlink" title="7.后缀（空格）绕过"></a>7.后缀（空格）绕过</h4><p>系统上的文件，如果你修改后缀名，在后缀名后面加一个空格，操作系统就会默认把最后免得空格清除掉，来保证文件正常运行，但是在检测机制当中，单纯的后缀名与后缀名后面加一个空格是不一样的，这样我们就可以利用这种方法进行绕过了</p>
<ul>
<li>抓包把 1.php 写成 1.php空格</li>
</ul>
<p>这样检测机制认为php空格 和php不是一个类型，就通过了，上传到后台后，后台自动把最后一个空格去掉了，文件依旧可以执行了</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240109200325436.png" alt="image-20240109200325436"></p>
<h4 id="8-后缀添加"><a href="#8-后缀添加" class="headerlink" title="8.后缀添加."></a>8.后缀添加.</h4><p>在文件后缀名后加一个<code>.</code>。</p>
<h4 id="9-后缀添加-DATA"><a href="#9-后缀添加-DATA" class="headerlink" title="9.后缀添加::$DATA"></a>9.后缀添加::$DATA</h4><p>在后缀名后添加<code>::$DATA</code>。</p>
<h4 id="10-后缀添加"><a href="#10-后缀添加" class="headerlink" title="10.后缀添加. ."></a>10.后缀添加. .</h4><p>在文件名后面添加<code>. .</code>。</p>
<p>只进行了一次<code>.</code>和空格的检验。</p>
<h4 id="11-后缀名重写绕过"><a href="#11-后缀名重写绕过" class="headerlink" title="11.后缀名重写绕过"></a>11.后缀名重写绕过</h4><p>文件后缀名只删除了一次。</p>
<h4 id="12-白名单"><a href="#12-白名单" class="headerlink" title="12.白名单"></a>12.白名单</h4><p>上传白名单,最后的路径是靠拼接,可以使用%00截断<br>原理：php的一些函数的底层是C语言，而move_uploaded_file就是其中之一，遇到0x00会截断，0x表示16进制，URL中%00解码成16进制就是0x00。</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240117192248457.png" alt="image-20240117192248457"></p>
<h4 id="13-白名单（post）"><a href="#13-白名单（post）" class="headerlink" title="13.白名单（post）"></a>13.白名单（post）</h4><p>与上关一样,区别是post提交,post不会对里面的数据自动解码，需要在Hex中修改。</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240117192510344.png" alt="image-20240117192510344"></p>
<p><img src="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240117192727762.png" alt="image-20240117192727762"></p>
<h4 id="14-图片包含马"><a href="#14-图片包含马" class="headerlink" title="14.图片包含马"></a>14.图片包含马</h4><p>常用图片格式：</p>
<table>
<thead>
<tr>
<th>图片格式</th>
<th>开头，结尾</th>
</tr>
</thead>
<tbody><tr>
<td>Gif格式图片的文件头标识</td>
<td>GIF89a 或 GIF87a</td>
</tr>
<tr>
<td>Jpg格式图片的文件头标识</td>
<td>FFD8开头FFD9结尾</td>
</tr>
<tr>
<td>Png格式图片的文件头标识</td>
<td>89 20 4E 47 0D 0A</td>
</tr>
</tbody></table>
<p>会判断强两个字节的来确定上传文件的后缀是否为白名单里的,需要上传图片马配合文件包含漏洞上传图片马</p>
<p>在命令行将图片和马进行拼接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy .\1.png/b+.\zhang.php zhang1.jpg</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240117194646736.png" alt="image-20240117194646736"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">连接的地址为：</span><br><span class="line">http://192.168.2.59/upload-labs-master/include.php?file=./upload/6520240117195842.jpg</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zhenghuangfei/tu@main//imgimage-20240117200444545.png" alt="image-20240117200444545"></p>
<h4 id="15"><a href="#15" class="headerlink" title="15"></a>15</h4><p>在上关的基础上,校验图片的大小,依旧可以和上关一样使用图片马绕过</p>
<h4 id="16"><a href="#16" class="headerlink" title="16"></a>16</h4><p>在上关的基础上再检查后缀,依旧使用图片马绕过</p>
<h4 id="17"><a href="#17" class="headerlink" title="17"></a>17</h4><p>图片马传就完事了</p>
<h4 id="18"><a href="#18" class="headerlink" title="18"></a>18</h4><p>本系统是将文件先存在临时文件夹中再进行判断是否为正确的文件，当传输了很多的写木马的文件则服务器可能出错执行了写木马的操作。</p>
<p>需要进行抓包并发送有木马的数据包，使服务器出错。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/09/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/" data-id="clrmsspo00006j0u461r50rsw" class="article-share-link">分享</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2024/01/09/upload%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6-%E9%9D%B6%E6%9C%BA/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          AttackMachine(考试机)-&gt;靶场
        
      </div>
    </a>
  
  
    <a href="/2024/01/08/nmap%E4%BD%BF%E7%94%A8/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">nmap使用</div>
    </a>
  
</nav>

  
</article>



</section>
        
          <aside id="sidebar">
  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <h1 class="blog-title">Hexo</h1>
    <h2 class="blog-subtitle"></h2>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>主页</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>归档</li>
          </a>
        
          <a href="/categories" title="Categories">
            <li>分类</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>标签</li>
          </a>
        
    </ul>
  </div>
</div>

  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="https://avatars0.githubusercontent.com/u/20333903?v=3&amp;s=460">
    <h2 class="author">John Doe</h2>
    <h3 class="description"></h3>
    <div class="count-box">
      <a href="/archives"><div><strong>65</strong><br>文章</div></a>
      <a href="/categories"><div><strong>0</strong><br>分类</div></a>
      <a href="/tags"><div><strong>1</strong><br>标签</div></a>
    </div>



    <div class="social-link">
      
        <a class="hvr-bounce-in" href="http://github.com/ShanaMaid" target="_blank" title="Github">
          Github
        </a>
      
    </div>

    <div class="friend-link">
      <h2>友情链接</h2>
      
        <a class="hvr-bounce-in" href="http://blog.shanamaid.top/" target="_blank" title="ShanaMaid">
          ShanaMaid
        </a>
      
    </div>
  </div>
</div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy;2023 - 2024 John Doe<br>
      由<a href="http://hexo.io/" target="_blank">Hexo</a>强力驱动 | 
      主题-<a target="_blank" rel="noopener" href="https://github.com/ShanaMaid/hexo-theme-shana">Shana</a>
      
    </div>
    
  </div>
</footer>
    </div>
    

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="//apps.bdimg.com/libs/wow/0.1.6/wow.min.js"></script>
<script>
new WOW().init();
</script>   


  
<link rel="stylesheet" href="/plugin/fancybox/jquery.fancybox.css">

  
<script src="/plugin/fancybox/jquery.fancybox.pack.js"></script>




  
<link rel="stylesheet" href="/plugin/galmenu/GalMenu.css">

  
<script src="/plugin/galmenu/GalMenu.js"></script>

  <div class="GalMenu GalDropDown">
      <div class="circle" id="gal">
        <div class="ring">
          
            <a href="/" title="" class="menuItem">首页</a>
          
            <a href="/tags" title="" class="menuItem">标签</a>
          
            <a href="/categories" title="" class="menuItem">分类</a>
          
            <a href="/archives" title="" class="menuItem">归档</a>
          
            <a href="/xxxxxxxxx" title="" class="menuItem">xxx</a>
          
            <a href="/xxxxxxx" title="" class="menuItem">xxxx</a>
          
        </div>
        
          <audio id="audio" src="#"></audio>
        
      </div> 
</div>
<div id="overlay" style="opacity: 1; cursor: pointer;"></div>
  <script type="text/javascript">var items = document.querySelectorAll('.menuItem');
    for (var i = 0,
    l = items.length; i < l; i++) {
      items[i].style.left = (50 - 35 * Math.cos( - 0.5 * Math.PI - 2 * (1 / l) * i * Math.PI)).toFixed(4) + "%";
      items[i].style.top = (50 + 35 * Math.sin( - 0.5 * Math.PI - 2 * (1 / l) * i * Math.PI)).toFixed(4) + "%"
    }</script>
<script type="text/javascript">
  $(document).ready(function() {
    $('body').GalMenu({
      'menu': 'GalDropDown'
    })
  });
</script>

  <section class="hidden-xs"> 
  <ul class="cb-slideshow"> 
    <li><span>苟利</span></li> 
    <li><span>国家</span></li> 
    <li><span>生死以</span></li> 
    <li><span>岂能</span></li> 
    <li><span>祸福</span></li> 
    <li><span>趋避之</span></li> 
  </ul>
</section>

<script src="/js/script.js"></script>




  </div>
</body>
</html>